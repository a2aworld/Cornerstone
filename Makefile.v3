# A2A-World V3.0 Makefile
# Simplified commands for the Planetary Rosetta Stone MVP

.PHONY: help init up down logs test clean rebuild db-shell gebco-test

help:
	@echo "ðŸŒ A2A-World V3.0: The Planetary Rosetta Stone"
	@echo ""
	@echo "Available commands:"
	@echo "  make init        - Initialize the entire environment (first-time setup)"
	@echo "  make up          - Start all services"
	@echo "  make down        - Stop all services"
	@echo "  make logs        - View logs from all services"
	@echo "  make test        - Run the complete test suite (THE PACT)"
	@echo "  make clean       - Stop services and remove volumes (DELETES DATA)"
	@echo "  make rebuild     - Rebuild Docker images and restart"
	@echo "  make db-shell    - Open PostgreSQL shell"
	@echo "  make gebco-test  - Test GEBCO bathymetry integration"
	@echo ""

init:
	@echo "ðŸš€ Initializing A2A-World V3.0..."
	@echo "This will:"
	@echo "  1. Build all Docker images"
	@echo "  2. Start PostgreSQL with simplified schema"
	@echo "  3. Start Redis cache"
	@echo "  4. Start A2A Server V3 with 3 sacred endpoints"
	@echo ""
	docker-compose -f docker-compose.v3.yml up --build -d
	@echo ""
	@echo "â³ Waiting for services to be healthy..."
	@sleep 10
	@echo ""
	@echo "âœ… A2A-World V3.0 is running!"
	@echo ""
	@echo "ðŸŒ API Documentation: http://localhost:8000/docs"
	@echo "ðŸ’“ Health Check: http://localhost:8000/health"
	@echo "ðŸ† Leaderboard: http://localhost:8000/leaderboard"
	@echo "ðŸšª Heaven's Gates Progress: http://localhost:8000/heavens-gates-progress"
	@echo ""
	@echo "Ready to give AI agents their first glimpse of Earth."

up:
	@echo "â–¶ï¸  Starting A2A-World V3.0..."
	docker-compose -f docker-compose.v3.yml up -d
	@echo "âœ… Services started. Check status with: make logs"

down:
	@echo "â¸ï¸  Stopping A2A-World V3.0..."
	docker-compose -f docker-compose.v3.yml down
	@echo "âœ… Services stopped."

logs:
	@echo "ðŸ“œ Showing logs (Ctrl+C to exit)..."
	docker-compose -f docker-compose.v3.yml logs -f

test:
	@echo "ðŸ§ª Running THE PACT test suite..."
	@echo "All tests must pass before code ships."
	@echo ""
	docker-compose -f docker-compose.v3.yml exec a2a-server-v3 pytest test_v3_api.py -v --cov=v3_main --cov-report=term-missing
	@echo ""
	@echo "âœ… If all tests passed, the code is VERIFIED."
	@echo "âŒ If any tests failed, DO NOT SHIP."

clean:
	@echo "ðŸ§¹ Cleaning up A2A-World V3.0..."
	@echo "âš ï¸  WARNING: This will DELETE all data!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	echo; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		docker-compose -f docker-compose.v3.yml down -v; \
		echo "âœ… All services stopped and volumes removed."; \
	else \
		echo "âŒ Cancelled."; \
	fi

rebuild:
	@echo "ðŸ”¨ Rebuilding A2A-World V3.0..."
	docker-compose -f docker-compose.v3.yml down
	docker-compose -f docker-compose.v3.yml up --build -d
	@echo "âœ… Rebuild complete."

db-shell:
	@echo "ðŸ’¾ Opening PostgreSQL shell..."
	docker-compose -f docker-compose.v3.yml exec postgres psql -U a2a -d a2a_world_v3

gebco-test:
	@echo "ðŸ—ºï¸  Testing GEBCO bathymetry integration..."
	@echo "Fetching sample tile for Easter Island region..."
	curl -s "https://www.gebco.net/data_and_products/gebco_web_services/web_map_service/?service=WMS&version=1.3.0&request=GetMap&layers=GEBCO_LATEST&bbox=-110,-30,-105,-25&width=512&height=512&crs=EPSG:4326&format=image/png" -o /tmp/gebco_test.png
	@if [ -f /tmp/gebco_test.png ]; then \
		echo "âœ… GEBCO tile retrieved successfully"; \
		echo "ðŸ“ Saved to: /tmp/gebco_test.png"; \
		echo "ðŸŒŠ This is what AI agents will see when they look at the ocean floor."; \
	else \
		echo "âŒ GEBCO test failed"; \
	fi

# Quick status check
status:
	@echo "ðŸ“Š A2A-World V3.0 Status"
	@echo ""
	@docker-compose -f docker-compose.v3.yml ps
	@echo ""
	@echo "Database:"
	@docker-compose -f docker-compose.v3.yml exec -T postgres psql -U a2a -d a2a_world_v3 -c "SELECT COUNT(*) as total_agents FROM agents;" 2>/dev/null || echo "Database not ready"
	@echo ""
	@echo "Heaven's Gates Progress:"
	@docker-compose -f docker-compose.v3.yml exec -T postgres psql -U a2a -d a2a_world_v3 -c "SELECT * FROM heavens_gates_progress;" 2>/dev/null || echo "Database not ready"

# Quick agent registration test
quick-test:
	@echo "âš¡ Quick registration test..."
	@curl -X POST http://localhost:8000/register \
		-H "Content-Type: application/json" \
		-d '{"external_id":"quicktest_agent","name":"QuickTestAgent","framework":"curl"}' \
		2>/dev/null | python3 -m json.tool || echo "Server not responding"
